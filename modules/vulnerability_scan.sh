#!/bin/bash

# استيراد الإعدادات العامة
source "../config.sh"

# دالة فحص نقاط الضعف المحتملة
scan_vulnerabilities() {
    local domain="$1"
    
    # التحقق من صحة النطاق
    if [[ -z "$domain" ]]; then
        log_message "ERROR" "No domain specified for vulnerability scan"
        return 1
    fi
    
    # إنشاء مجلد للنتائج
    local results_dir="${REPORT_DIR}/vulnerability_scan_${domain}"
    mkdir -p "$results_dir"
    
    log_message "INFO" "Starting vulnerability scan for domain: $domain"
    
    # 1. فحص SSL/TLS باستخدام testssl.sh
    log_message "INFO" "Performing SSL/TLS vulnerability check"
    if command -v testssl.sh &> /dev/null; then
        testssl.sh "https://$domain" > "${results_dir}/ssl_vulnerabilities.txt"
    else
        log_message "WARNING" "testssl.sh not installed. Skipping detailed SSL check"
    fi
    
    # 2. فحص نقاط الضعف الشائعة باستخدام nmap
    log_message "INFO" "Scanning for common vulnerabilities"
    nmap -sV --script vuln "$domain" > "${results_dir}/nmap_vulnerabilities.txt"
    
    # 3. فحص الثغرات المعروفة باستخدام searchsploit
    log_message "INFO" "Checking known exploits"
    if command -v searchsploit &> /dev/null; then
        searchsploit "$domain" > "${results_dir}/known_exploits.txt"
    else
        log_message "WARNING" "searchsploit not installed. Skipping exploit search"
    fi
    
    # 4. تحليل الثغرات
    local vulnerability_report="${results_dir}/vulnerability_assessment.txt"
    {
        echo "Vulnerability Assessment Report for Domain: $domain"
        echo "-------------------------------------------"
        
        # تحليل نتائج nmap
        echo "1. Nmap Vulnerability Scan Results:"
        grep -E "VULNERABLE|CVE" "${results_dir}/nmap_vulnerabilities.txt" || echo "No critical vulnerabilities detected"
        
        # تحليل نتائج SSL
        echo -e "\n2. SSL/TLS Vulnerability Assessment:"
        if [ -f "${results_dir}/ssl_vulnerabilities.txt" ]; then
            grep -E "VULNERABLE|WEAK" "${results_dir}/ssl_vulnerabilities.txt" || echo "No significant SSL vulnerabilities found"
        else
            echo "SSL scan not performed"
        fi
        
        # تحليل الثغرات المعروفة
        echo -e "\n3. Known Exploits:"
        if [ -f "${results_dir}/known_exploits.txt" ]; then
            cat "${results_dir}/known_exploits.txt" || echo "No known exploits found"
        else
            echo "Exploit search not performed"
        fi
    } > "$vulnerability_report"
    
    log_message "SUCCESS" "Completed vulnerability scan"
    
    return 0
}

# تصدير الدالة للاستخدام في وحدات أخرى
export -f scan_vulnerabilities