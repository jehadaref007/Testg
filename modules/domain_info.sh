#!/bin/bash

# استيراد الإعدادات العامة
source "../config.sh"

# دالة استخراج معلومات النطاق المتقدمة
استخراج_معلومات_النطاق() {
    local نطاق="$1"
    
    # التحقق من صحة النطاق
    if [[ -z "$نطاق" ]]; then
        سجل_الرسالة "خطأ" "لم يتم تحديد نطاق للتحليل"
        return 1
    fi
    
    # إنشاء مجلد مؤقت للنتائج
    local مجلد_النتائج="${REPORT_DIR}/معلومات_نطاق_${نطاق}"
    mkdir -p "$مجلد_النتائج"
    
    سجل_الرسالة "معلومات" "بدء استخراج معلومات النطاق: $نطاق"
    
    # 1. معلومات whois
    سجل_الرسالة "معلومات" "جمع معلومات whois"
    whois "$نطاق" > "${مجلد_النتائج}/whois_info.txt" 2>&1
    
    # 2. معلومات DNS
    سجل_الرسالة "معلومات" "استخراج سجلات DNS"
    {
        echo "--- سجلات A ---"
        dig A "$نطاق"
        
        echo -e "\n--- سجلات MX ---"
        dig MX "$نطاق"
        
        echo -e "\n--- سجلات NS ---"
        dig NS "$نطاق"
    } > "${مجلد_النتائج}/dns_records.txt" 2>&1
    
    # 3. عناوين IP
    سجل_الرسالة "معلومات" "استخراج عناوين IP"
    {
        echo "IPv4:"
        dig +short "$نطاق"
        
        echo -e "\nIPv6:"
        dig AAAA +short "$نطاق"
    } > "${مجلد_النتائج}/ip_addresses.txt" 2>&1
    
    # 4. معلومات الاستضافة
    سجل_الرسالة "معلومات" "جمع معلومات الاستضافة"
    curl -s "https://ipapi.co/$نطاق/json/" > "${مجلد_النتائج}/hosting_info.json"
    
    سجل_الرسالة "نجاح" "اكتمال استخراج معلومات النطاق"
    
    return 0
}

# تصدير الدالة للاستخدام في وحدات أخرى
export -f استخراج_معلومات_النطاق